<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VSCode WebSocket Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    h1 {
      color: #3b82f6;
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      background: #2a2a2a;
      border: 1px solid #444;
    }
    .connected {
      background: #065f46;
      border-color: #10b981;
    }
    .disconnected {
      background: #7f1d1d;
      border-color: #ef4444;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: all 0.2s;
    }
    button:hover:not(:disabled) {
      background: #2563eb;
      transform: translateY(-1px);
    }
    button:disabled {
      background: #444;
      cursor: not-allowed;
      opacity: 0.6;
    }
    textarea {
      width: 100%;
      height: 120px;
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 10px;
      font-family: monospace;
      margin: 10px 0;
    }
    .log {
      background: #000;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      margin: 20px 0;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #444;
    }
    .log-sent {
      border-left-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
    }
    .log-received {
      border-left-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }
    .log-error {
      border-left-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }
  </style>
</head>
<body>
  <h1>VSCode WebSocket Test - Port 7651</h1>
  
  <div id="status" class="status disconnected">
    Status: <span id="status-text">Disconnected</span>
  </div>

  <div>
    <button id="connect-btn" onclick="connect()">Connect to VSCode</button>
    <button id="disconnect-btn" onclick="disconnect()" disabled>Disconnect</button>
    <button id="check-status-btn" onclick="checkChatStatus()" disabled>Check Chat Status</button>
  </div>

  <div>
    <h3>Send Message to Chat Input:</h3>
    <textarea id="message-input" placeholder="Enter message to send to VSCode chat...">I want to use the following components on my site:

• Hero (prestongarrison.com/data/hero.json)
• ProjectsHeader (prestongarrison.com/data/projects-header.json)

Components selected from dashboard.</textarea>
    <div>
      <button id="send-btn" onclick="sendMessage()" disabled>Send to Chat Input</button>
      <button onclick="sendTestMessage()" id="test-btn" disabled>Send Test Message</button>
      <button onclick="clearLog()">Clear Log</button>
    </div>
  </div>

  <div class="log" id="log">
    <div class="log-entry">WebSocket test ready. Click "Connect to VSCode" to start.</div>
  </div>

  <script>
    let ws = null;
    let isConnected = false;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
      log('Log cleared');
    }

    function updateStatus(connected) {
      isConnected = connected;
      const statusDiv = document.getElementById('status');
      const statusText = document.getElementById('status-text');
      
      if (connected) {
        statusDiv.className = 'status connected';
        statusText.textContent = 'Connected to VSCode WebSocket on port 7651';
      } else {
        statusDiv.className = 'status disconnected';
        statusText.textContent = 'Disconnected';
      }
      
      // Update button states
      document.getElementById('connect-btn').disabled = connected;
      document.getElementById('disconnect-btn').disabled = !connected;
      document.getElementById('send-btn').disabled = !connected;
      document.getElementById('test-btn').disabled = !connected;
      document.getElementById('check-status-btn').disabled = !connected;
    }

    function connect() {
      if (ws) {
        log('Already connected or connecting...', 'error');
        return;
      }

      try {
        log('Connecting to ws://localhost:7651...', 'sent');
        ws = new WebSocket('ws://localhost:7651');

        ws.onopen = () => {
          log('WebSocket connection opened!', 'received');
          updateStatus(true);
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            log(`Received: ${JSON.stringify(data, null, 2)}`, 'received');
            
            // Handle specific message types
            if (data.type === 'error') {
              alert(`Error from VSCode: ${data.error}`);
            } else if (data.type === 'success') {
              alert('Message sent to VSCode chat successfully!');
            } else if (data.type === 'chatStatus') {
              alert(`Chat panel status: ${data.message}`);
            }
          } catch (err) {
            log(`Received non-JSON message: ${event.data}`, 'received');
          }
        };

        ws.onerror = (error) => {
          log(`WebSocket error: ${error}`, 'error');
          alert('WebSocket error - check if VSCode extension is running');
        };

        ws.onclose = () => {
          log('WebSocket connection closed', 'error');
          updateStatus(false);
          ws = null;
        };

      } catch (error) {
        log(`Failed to connect: ${error.message}`, 'error');
        ws = null;
      }
    }

    function disconnect() {
      if (ws) {
        log('Closing connection...', 'sent');
        ws.close();
        ws = null;
      }
    }

    function sendMessage() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('Not connected to VSCode');
        return;
      }

      const message = document.getElementById('message-input').value;
      if (!message.trim()) {
        alert('Please enter a message');
        return;
      }

      const payload = {
        type: 'fillChatInput',
        text: message
      };

      log(`Sending: ${JSON.stringify(payload, null, 2)}`, 'sent');
      ws.send(JSON.stringify(payload));
    }

    function sendTestMessage() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('Not connected to VSCode');
        return;
      }

      const payload = {
        type: 'fillChatInput',
        text: 'Hello from WebSocket test! Connection working at ' + new Date().toLocaleTimeString()
      };

      log(`Sending test: ${JSON.stringify(payload, null, 2)}`, 'sent');
      ws.send(JSON.stringify(payload));
    }

    function checkChatStatus() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('Not connected to VSCode');
        return;
      }

      const payload = {
        type: 'getChatStatus'
      };

      log(`Sending: ${JSON.stringify(payload, null, 2)}`, 'sent');
      ws.send(JSON.stringify(payload));
    }

    // Auto-connect on page load for convenience
    window.addEventListener('load', () => {
      log('Page loaded. Ready to connect to VSCode WebSocket on port 7651');
      // Uncomment to auto-connect:
      // setTimeout(connect, 500);
    });
  </script>
</body>
</html>