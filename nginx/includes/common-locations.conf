# Common location blocks for all domains
# This file is included by the catch-all server blocks

# Security headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Logging (uses domain name in log files)
access_log /var/log/nginx/${host}_access.log;
error_log /var/log/nginx/${host}_error.log;

# Maximum upload size (100MB)
client_max_body_size 100M;

# Proxy timeouts
proxy_connect_timeout 600;
proxy_send_timeout 600;
proxy_read_timeout 600;
send_timeout 600;

# Extract site ID from domain for database routing
set $site_id "default";
if ($host ~* ^(?:www\.)?([^.]+)\..*$) {
    set $site_id $1;
}

# API routes - proxy to backend container
location /api {
    proxy_pass http://127.0.0.1:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Site-Database "${site_id}_db";
    
    # Check for domain-specific API overrides
    include /etc/nginx/includes/api-overrides/${host}.conf*;
}

# Serve uploads directly from nginx (more efficient than proxying)
location /uploads {
    # Maps to host directory (outside Docker)
    alias /var/www/docker/uploads;
    expires 30d;
    add_header Cache-Control "public, immutable";
    
    # Prevent directory listing
    autoindex off;
    
    # Only serve files, not directories
    try_files $uri =404;
    
    # Check for domain-specific upload overrides
    include /etc/nginx/includes/upload-overrides/${host}.conf*;
}

# Serve public directory assets directly from disk
# Each domain gets its own public directory space
location /public {
    # Map to site-specific public directory on host
    alias /var/www/docker/public/$site_id;
    
    expires 30d;
    add_header Cache-Control "public, immutable";
    
    # Prevent directory listing
    autoindex off;
    
    # Try files, then 404
    try_files $uri $uri/ =404;
    
    # Check for domain-specific public overrides
    include /etc/nginx/includes/public-overrides/${host}.conf*;
}

# Blog-specific uploads and media
# Each domain's blog has its own media space
location ~ ^/blog/(uploads|media|images)/ {
    # Blog media is stored per-domain on the host
    # /var/www/docker/uploads/blog/{domain}/...
    alias /var/www/docker/uploads/blog/$site_id/;
    
    expires 30d;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    
    # Prevent directory listing
    autoindex off;
    
    try_files $uri =404;
}

# Common static assets (images, fonts, etc.)
# These are served directly without proxying to Node
location ~* ^/(images|img|assets|static|media|downloads|fonts|favicon\.ico|robots\.txt)(/|$) {
    # Try site-specific public directory first
    root /var/www/docker;
    
    # Priority order:
    # 1. Site-specific public directory: /var/www/docker/public/{site_id}/...
    # 2. Shared public directory: /var/www/docker/public/shared/...
    # 3. Fallback to frontend for built assets or dynamic handling
    try_files 
        /public/$site_id$uri 
        /public/shared$uri
        @frontend;
    
    expires 30d;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff" always;
}

# Fallback to frontend for dynamic routes
location @frontend {
    proxy_pass http://127.0.0.1:4321;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# WebSocket support
location /ws {
    proxy_pass http://127.0.0.1:4321;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Static assets with long cache
location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|otf|eot)$ {
    proxy_pass http://127.0.0.1:4321;
    expires 30d;
    add_header Cache-Control "public, immutable";
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    
    # Check for domain-specific static overrides
    include /etc/nginx/includes/static-overrides/${host}.conf*;
}

# Main application - proxy to Astro SSR frontend
location / {
    proxy_pass http://127.0.0.1:4321;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Check for domain-specific route overrides
    include /etc/nginx/includes/route-overrides/${host}.conf*;
}

# Include any domain-specific additional locations
include /etc/nginx/includes/custom-locations/${host}.conf*;

# Gzip compression
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml application/atom+xml image/svg+xml text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype;