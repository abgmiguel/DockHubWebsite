---
import Layout from '../../layouts/Layout.astro';
import BlogPostViewer from './components/BlogPostViewer';
import { API_URL } from '../../shared/lib/api-config';

const { slug } = Astro.params;
const response = await fetch(`${API_URL}/api/posts/${slug}`);
const post = response.ok ? await response.json() : null;

if (!post) {
  return Astro.redirect('/blog');
}

// Transform the post data to match what BlogPostViewer expects
const formattedPost = {
  id: post._id || post.id,
  title: post.title,
  content: post.content,
  category_data: post.category_data,
  coverImage: post.coverImage,
  author_data: post.author_data || post.author || { name: 'Admin', email: 'admin@codersinflow.com' },
  readingTime: post.readingTime || 5,
  createdAt: post.created_at || post.createdAt || new Date().toISOString()
};
---

<Layout 
  title={post.title}
  description={post.description || post.excerpt || `Read ${post.title} on Coders in Flow`}
  image={post.coverImage}
>
  <BlogPostViewer client:load post={formattedPost} />
</Layout>