[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

[program:mongodb]
command=/usr/bin/mongod --dbpath /data/db --bind_ip 127.0.0.1 --port 27017 --auth
autostart=true
autorestart=true
priority=1
stdout_logfile=/var/log/supervisor/mongodb.log
stderr_logfile=/var/log/supervisor/mongodb_err.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile_backups=2

[program:init-admin]
command=/app/backend/init-admin
directory=/app/backend
autostart=true
autorestart=false
priority=5
startsecs=1
startretries=3
exitcodes=0
environment=
    MONGODB_URI="mongodb://admin:%(ENV_MONGO_PASSWORD)s@127.0.0.1:27017/codersblog?authSource=admin",
    JWT_SECRET="%(ENV_JWT_SECRET)s"
stdout_logfile=/var/log/supervisor/init-admin.log
stderr_logfile=/var/log/supervisor/init-admin_err.log

[program:backend]
command=/app/backend/server
directory=/app/backend
autostart=true
autorestart=true
priority=10
startsecs=5
startretries=3
environment=
    MONGODB_URI="mongodb://admin:%(ENV_MONGO_PASSWORD)s@127.0.0.1:27017/codersblog?authSource=admin",
    JWT_SECRET="%(ENV_JWT_SECRET)s",
    PORT="3001",
    NODE_ENV="production",
    CORS_ORIGIN="https://%(ENV_DOMAIN)s",
    GOMAXPROCS="%(ENV_GOMAXPROCS)s",
    GOGC="%(ENV_GOGC)s"
stdout_logfile=/var/log/supervisor/backend.log
stderr_logfile=/var/log/supervisor/backend_err.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5

[group:webstack]
programs=mongodb,init-admin,backend
priority=999

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock